name: Validate and Deploy

on:
    push:
        branches: [main, staging]
    pull_request:
        branches: [main, staging]

concurrency:
    group: sakalsense-${{ github.ref }}
    cancel-in-progress: true

jobs:
    validate-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            # --- Version check for production ---
            - name: Check frontend version bump
              id: version-frontend
              if: github.ref == 'refs/heads/main'
              run: |
                  PREV=$(git show HEAD~1:apps/frontend/package.json | jq -r .version 2>/dev/null || echo "0.0.0")
                  CURR=$(jq -r .version apps/frontend/package.json)
                  echo "prev=$PREV" >> $GITHUB_OUTPUT
                  echo "curr=$CURR" >> $GITHUB_OUTPUT
                  if [ "$PREV" != "$CURR" ]; then
                    echo "deploy=true" >> $GITHUB_OUTPUT
                    echo "✅ Frontend: $PREV → $CURR (will deploy)"
                  else
                    echo "deploy=false" >> $GITHUB_OUTPUT
                    echo "⏭️ Frontend: $CURR (no change, skip deploy)"
                  fi

            - name: Check backend version bump
              id: version-backend
              if: github.ref == 'refs/heads/main'
              run: |
                  PREV=$(git show HEAD~1:apps/backend/package.json | jq -r .version 2>/dev/null || echo "0.0.0")
                  CURR=$(jq -r .version apps/backend/package.json)
                  echo "prev=$PREV" >> $GITHUB_OUTPUT
                  echo "curr=$CURR" >> $GITHUB_OUTPUT
                  if [ "$PREV" != "$CURR" ]; then
                    echo "deploy=true" >> $GITHUB_OUTPUT
                    echo "✅ Backend: $PREV → $CURR (will deploy)"
                  else
                    echo "deploy=false" >> $GITHUB_OUTPUT
                    echo "⏭️ Backend: $CURR (no change, skip deploy)"
                  fi

            # --- Setup ---
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # --- Validate ---
            - name: Lint
              run: pnpm -r lint

            - name: Type check
              run: pnpm -r type-check

            # --- Deploy (only on main with version change) ---
            - name: Install Vercel CLI
              if: github.ref == 'refs/heads/main' && (steps.version-frontend.outputs.deploy == 'true' || steps.version-backend.outputs.deploy == 'true')
              run: npm i -g vercel@latest

            - name: Build Core Package
              if: github.ref == 'refs/heads/main' && (steps.version-frontend.outputs.deploy == 'true' || steps.version-backend.outputs.deploy == 'true')
              run: pnpm --filter @sakalsense/core build

            - name: Deploy Frontend
              if: github.ref == 'refs/heads/main' && steps.version-frontend.outputs.deploy == 'true'
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_FRONTEND_PROJECT_ID }}
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              run: |
                  vercel pull --yes --environment=production --token=$VERCEL_TOKEN
                  vercel build --prod --token=$VERCEL_TOKEN
                  vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

            - name: Build Backend
              if: github.ref == 'refs/heads/main' && steps.version-backend.outputs.deploy == 'true'
              run: pnpm --filter @sakalsense/backend build

            - name: Deploy Backend
              if: github.ref == 'refs/heads/main' && steps.version-backend.outputs.deploy == 'true'
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_BACKEND_PROJECT_ID }}
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              run: |
                  vercel pull --yes --environment=production --token=$VERCEL_TOKEN
                  vercel deploy --prod --token=$VERCEL_TOKEN
